<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>PixHaven | Sign In</title>
        <link rel="stylesheet" href="../styles/auth.css">
        <link rel="icon"
            href="./generative-ai-logo-artificial-intelligence-icon-symbol-vector-illustrationhgh_838872-2065.jpg"
            type="image/jpeg">
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet">
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" type="text/css"
            href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    </head>

    <body>
        <div class="auth-container">
            <div class="auth-box">
                <h1>Welcome Back ðŸ‘‹</h1>
                <p class="subtitle">Sign in to continue to
                    <strong>PixHaven</strong>
                </p>

                <form class="auth-form">
                    <input type="email" id="email" placeholder="Email Address"
                        required>
                    <div class="password-wrapper">
                        <input type="password" id="password" name="password"
                            placeholder="Password" required>
                        <i class="fa fa-eye" id="showPassword"
                            title="Show password"></i>
                    </div>
                </form>
                <button class="btn" id="withMail" onclick="withEmail()"><span
                        class="sign">Sign
                        In</span></button>

                <div class="divider">or continue with</div>

                <div class="social-login">
                    <button class="social-btn google" onclick="withGoogle()"><i
                            class="fab fa-google"></i> Google</button>
                    <button class="social-btn github" onclick="withGit()"><i
                            class="fab fa-github"></i> GitHub</button>
                    <button class="social-btn apple"><i
                            class="fab fa-apple"></i> Apple ID</button>
                </div>

                <p class="switch">Don't have an account? <a
                        href="./signup.html">Sign Up</a></p>
            </div>
        </div>

        <script type="text/javascript"
            src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            signInWithEmailAndPassword,
            GithubAuthProvider,
            signOut
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getDatabase, ref, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAZeXRLtizNVxoROHfCWwYFZYzCrrHUVjs",
            authDomain: "pixhaven-gallary.firebaseapp.com",
            projectId: "pixhaven-gallary",
            storageBucket: "pixhaven-gallary.firebasestorage.app",
            messagingSenderId: "22248391827",
            appId: "1:22248391827:web:d6617252875deab4da3966"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const gitProvider = new GithubAuthProvider();
        const database = getDatabase(app);

        const userEmail = document.getElementById('email');
        const userPassword = document.getElementById('password');
        const emailBtn = document.getElementById('withMail');

        emailBtn.disabled = true;

        function checkValid() {
            if (userEmail.value.includes('@') && userPassword.value.trim().length >= 6) {
                emailBtn.disabled = false;
            } else {
                emailBtn.disabled = true;
            }
        }

        userEmail.addEventListener('input', checkValid);
        userPassword.addEventListener('input', checkValid);

        showPassword.addEventListener('click', () => {
            if (userPassword.type === 'password') {
                userPassword.type = 'text';
                showPassword.classList.add('fa-eye-slash');
                showPassword.classList.remove('fa-eye');
            } else {
                userPassword.type = 'password';
                showPassword.classList.add('fa-eye');
                showPassword.classList.remove('fa-eye-slash');
            }
        });

        window.withEmail = async function () {
            const email = userEmail.value.trim();
            const password = userPassword.value.trim();

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                await user.reload();

                if (!user.emailVerified) {
                    Toastify({
                        text: "Please verify your email before logging in.",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "#ff4d4d",
                    }).showToast();

                    await signOut(auth);
                    return;
                }

                await update(ref(database, 'users/' + user.uid), {
                    verified: true,
                    lastLoggedIn: new Date().toISOString(),
                });

                Toastify({
                    text: `Login successful! Welcome back ${user.displayName || user.email}! ðŸ‘‹`,
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#4CAF50",
                }).showToast();

                userEmail.value = '';
                userPassword.value = '';

                window.location.href  = './UsersDashboard/pages/usersDashboard.html'
            } catch (error) {
                let message = '';

                switch (error.code) {
                    case 'auth/invalid-credential':
                        message = 'Invalid email or password.';
                        break;
                    case 'auth/user-not-found':
                        message = 'No account found with this email.';
                        break;
                    case 'auth/wrong-password':
                        message = 'Incorrect password. Try again.';
                        break;
                    case 'auth/too-many-requests':
                        message = 'Too many failed attempts. Try again later.';
                        break;
                    default:
                        message = 'Login failed. Please try again.';
                        break;
                }

                Toastify({
                    text: message,
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#ff4d4d",
                }).showToast();

                checkValid();
            }
        };

        window.withGoogle = async function () {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                await update(ref(database, 'users/' + user.uid), {
                    lastLoggedIn: new Date().toISOString(),
                });

                Toastify({
                    text: `Login successful! Welcome back ${user.displayName}! ðŸ‘‹`,
                    duration: 4000,
                    gravity: "top",
                    position: "center",
                    style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                }).showToast();
            } catch (error) {
                let message = '';

                switch (error.code) {
                    case 'auth/popup-closed-by-user':
                        message = 'Sign-in canceled. Please try again.';
                        break;
                    case 'auth/account-exists-with-different-credential':
                        message = 'This email is linked with another provider. Use that instead.';
                        break;
                    default:
                        message = 'Google sign-in failed. Please try again.';
                        break;
                }

                Toastify({
                    text: message,
                    duration: 4000,
                    gravity: "top",
                    position: "center",
                    style: { background: "linear-gradient(to right, #ff4d4d, #ff9966)" }
                }).showToast();
            }
        };

        window.withGit = async function () {
            try {
                const result = await signInWithPopup(auth, gitProvider);
                const user = result.user;

                await update(ref(database, 'users/' + user.uid), {
                    lastLoggedIn: new Date().toISOString(),
                });

                Toastify({
                    text: `Login successful! Welcome back ${user.displayName || "GitHub User"}! ðŸ‘‹`,
                    duration: 4000,
                    gravity: "top",
                    position: "center",
                    style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                }).showToast();
            } catch (error) {
                let message = '';

                switch (error.code) {
                    case 'auth/popup-closed-by-user':
                        message = 'Sign-in canceled. Please try again.';
                        break;
                    case 'auth/account-exists-with-different-credential':
                        message = 'This GitHub is linked with another provider. Use that instead.';
                        break;
                    default:
                        message = 'GitHub sign-in failed. Please try again.';
                        break;
                }

                Toastify({
                    text: message,
                    duration: 4000,
                    gravity: "top",
                    position: "center",
                    style: { background: "linear-gradient(to right, #ff4d4d, #ff9966)" }
                }).showToast();
            }
        };
    </script>

    </body>

</html>