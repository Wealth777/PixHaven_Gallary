<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>PixHaven | Sign Up</title>
        <link rel="stylesheet" href="../styles/auth.css">
        <link rel="icon"
            href="./generative-ai-logo-artificial-intelligence-icon-symbol-vector-illustrationhgh_838872-2065.jpg"
            type="image/jpeg">
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet">
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" type="text/css"
            href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    </head>

    <body>
        <div class="auth-container">
            <div class="auth-box">
                <h1>Create Account ✨</h1>
                <p class="subtitle">Join <strong>PixHaven</strong> and start
                    exploring amazing images.</p>
                <p class="subtitle"><strong>Kindly use your real email to
                        register.</strong></p>

                <div class="emailInUse" id="emailInUse" role="status"
                    aria-live="polite">
                    <p id="emailInUseMessage" style="color: red;">Email already
                        in use. Use new email to register</p>
                </div>

                <div class="testMail" id="testMail" role="status"
                    aria-live="polite">
                    <p id="testMailMessage" style="color: red;">Please enter a
                        valid email address.</p>
                </div>

                <form class="auth-form">
                    <input type="text" id="username" placeholder="Username"
                        required>
                    <input type="email" id="email" placeholder="Email Address"
                        required>

                    <div class="password-wrapper">
                        <input type="password" id="password" name="password"
                            placeholder="Password" required>
                        <i class="fa fa-eye" id="showPassword"
                            title="Show password"></i>
                    </div>

                    <div class="verification-notice" id="verificationNotice"
                        role="status" aria-live="polite">
                        <p id="verificationMessage">A verification link has been
                            sent to your email.</p>
                        <p id="verificationMessage2">“Please check your email
                            inbox or spam folder to verify your account.”
                        </p>
                        <div class="verification-actions">
                            <button class="verification-btn"
                                id="openEmailBtn">Open Email</button>
                            <button class="verification-dismiss"
                                id="dismissVerification">Dismiss</button>
                        </div>
                    </div>
                </form>

                <button class="btn" onclick="withEmail()" id="withEmail"><span
                        class="sign">Sign Up</span></button>

                <div class="divider">or sign up with</div>

                <div class="social-login">
                    <button class="social-btn google" onclick="withGoogle()"><i
                            class="fab fa-google"></i> Google</button>
                    <button class="social-btn github" onclick="withGit()"><i
                            class="fab fa-github"></i> GitHub</button>
                    <button class="social-btn apple"><i
                            class="fab fa-apple"></i> Apple ID</button>
                </div>

                <p class="switch">Already have an account? <a
                        href="./signin.html">Sign In</a></p>
            </div>
        </div>

        <script type="text/javascript"
            src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

        <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, GithubAuthProvider, createUserWithEmailAndPassword, sendEmailVerification } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAZeXRLtizNVxoROHfCWwYFZYzCrrHUVjs",
            authDomain: "pixhaven-gallary.firebaseapp.com",
            databaseURL: "https://pixhaven-gallary-default-rtdb.firebaseio.com",
            projectId: "pixhaven-gallary",
            storageBucket: "pixhaven-gallary.firebasestorage.app",
            messagingSenderId: "22248391827",
            appId: "1:22248391827:web:d6617252875deab4da3966"
        };



        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const gitProvider = new GithubAuthProvider();
        const database = getDatabase(app);


        const withEmailBtn = document.getElementById('withEmail')
        const userNameEl = document.getElementById('username')
        const userEmailEl = document.getElementById('email')
        const userPasswordEl = document.getElementById('password')
        const showPassword = document.getElementById('showPassword')
        const verificationNotice = document.getElementById('verificationNotice')
        const openEmailBtn = document.getElementById('openEmailBtn')
        const dismissVerification = document.getElementById('dismissVerification')
        const errorMessage = document.getElementById('emailInUse')
        const testMessage = document.getElementById('testMail')



        withEmailBtn.disabled = true



        function checkValid() {
            if (
                userNameEl.value.trim() !== '' &&
                userEmailEl.value.includes('@') &&
                userPasswordEl.value.trim().length >= 6
            ) {
                withEmailBtn.disabled = false
            } else {
                withEmailBtn.disabled = true
            }
        }



        userNameEl.addEventListener('input', checkValid);
        userEmailEl.addEventListener('input', checkValid);
        userPasswordEl.addEventListener('input', checkValid);

        showPassword.addEventListener('click', () => {
            if (userPasswordEl.type === 'password') {
                userPasswordEl.type = 'text';
                showPassword.classList.add('fa-eye-slash')
                showPassword.classList.remove('fa-eye')
            } else {
                userPasswordEl.type = 'password';
                showPassword.classList.add('fa-eye')
                showPassword.classList.remove('fa-eye-slash')
            }
        })


        window.withEmail = async function () {
            const userName = userNameEl.value.trim()
            const userEmail = userEmailEl.value.trim()
            const userPassword = userPasswordEl.value.trim()

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(userEmail)) {
                Toastify({
                    text: "Please enter a valid email address",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "#ff4d4d",
                }).showToast();
                return;
            }

            const actionCodeSettings = {
                url: 'http://127.0.0.1:5500/Pixhaven/signup.html',
                handleCodeInApp: true,
            };


            try {
                const userCredential = await createUserWithEmailAndPassword(auth, userEmail, userPassword);
                const user = userCredential.user;
                const uid = user.uid

                await sendEmailVerification(user, actionCodeSettings);

                const messageEl = document.getElementById('verificationMessage')
                if (messageEl) {
                    messageEl.textContent = `A verification link has been sent to ${userEmail}.`;
                    verificationNotice.classList.add('active')
                }

                openEmailBtn.onclick = () => {
                    const domain = userEmail.split('@')[1] || ''
                    const lower = domain.toLowerCase()
                    let url = 'https://mail.google.com'
                    if (lower.includes('gmail')) url = 'https://mail.google.com'
                    else if (lower.includes('yahoo')) url = 'https://mail.yahoo.com'
                    else if (lower.includes('outlook') || lower.includes('hotmail') || lower.includes('live')) url = 'https://outlook.live.com'
                    else if (lower.includes('icloud') || lower.includes('me')) url = 'https://www.icloud.com/mail'
                    window.open(url, '_blank')
                }

                const db = getDatabase();
                await set(ref(db, 'users/' + uid), {
                    id: uid,
                    username: userName,
                    email: userEmail,
                    provider: "email",
                    verified: false,
                    createdAt: new Date().toISOString(),
                });

                Toastify({
                    text: "Signup successful! Please verify your email before logging in.",
                    duration: 4000,
                    gravity: "top",
                    position: "center",
                    style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                }).showToast();

                userNameEl.value = '';
                userEmailEl.value = '';
                userPasswordEl.value = '';
            }
            catch (error) {

                let message = '';
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        message = 'This email is already registered. Try signing in instead.';
                        break;
                    case 'auth/invalid-email':
                        message = 'The email address format is invalid.';
                        break;
                    case 'auth/weak-password':
                        message = 'Password should be at least 6 characters long.';
                        break;
                    default:
                        message = 'Signup failed. Please try again.';
                        break;
                }

                if (error.code === 'auth/email-already-in-use') {
                    const errmessageEl = document.getElementById('emailInUseMessage')
                    if (errmessageEl) {
                        errmessageEl.textContent = message;
                        emailInUse.classList.add('active')
                    }
                }
            };

        }




        dismissVerification.addEventListener('click', () => {
            verificationNotice.classList.remove('active')
        })




        window.withGoogle = async function () {
            try {
                const result = await signInWithPopup(auth, provider);
                const credential = GoogleAuthProvider.credentialFromResult(result);
                const token = credential.accessToken;

                const user = result.user;
                const db = getDatabase();
                await set(ref(db, 'users/' + user.uid), {
                    id: user.uid,
                    username: user.displayName,
                    email: user.email,
                    provider: "google",
                    createdAt: new Date().toISOString(),
                });

                Toastify({
                    text:  `Welcome ${user.displayName}! Signed in with Google.`,
                    duration: 4000,
                    gravity: "top",
                    position: "center",
                    style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                }).showToast();
            }
            catch (error) {
                let message = '';
                switch (error.code) {
                    case 'auth/popup-closed-by-user':
                        message = 'Sign-in canceled. Please try again.';
                        break;
                    case 'auth/account-exists-with-different-credential':
                        message = 'This email is linked with another provider. Try using that instead.';
                        break;
                    default:
                        message = 'Google sign-in failed. Please try again.';
                        break;
                }

                Toastify({
                    text: message,
                    duration: 4000,
                    gravity: "top",
                    position: "center",
                    style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                }).showToast();
            };
        }


        window.withGit = async function () {
            try {
                const result = await signInWithPopup(auth, gitProvider);
                const user = result.user;

                console.log(user)

                const db = getDatabase();
                await set(ref(db, 'users/' + user.uid), {
                    id: user.uid,
                    username: user.displayName,
                    email: user.email,
                    provider: "github",
                    createdAt: new Date().toISOString(),
                });

                Toastify({
                    text:  `Welcome ${user.displayName}! Signed in with Github.`,
                    duration: 4000,
                    gravity: "top",
                    position: "center",
                    style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                }).showToast();
            }
            catch (error) {
                console.log(error)
                let message = '';
                switch (error.code) {
                    case 'auth/popup-closed-by-user':
                        message = 'Sign-in canceled. Please try again.';
                        break;
                    case 'auth/account-exists-with-different-credential':
                        message = 'This github is linked with another provider. Try using that instead.';
                        break;
                    default:
                        message = 'Google sign-in failed. Please try again.';
                        break;
                }

                Toastify({
                    text: message,
                    duration: 4000,
                    gravity: "top",
                    position: "center",
                    style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                }).showToast();
            };
        }

    </script>
    </body>

</html>